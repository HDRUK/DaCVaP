---
title: Risk of adverse clotting and bleeding events following COVID-19 vaccination in the population of Wales
subtitle: Replication of analysis by Simpson et al. for Scotland
date: "Date compiled: `r format(Sys.time(), '%a %d %B %Y')`"
toc-title: Contents
always_allow_html: true
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
    code_folding: hide
---

```{r setup, include=FALSE}

quiet <- function(x) {
    sink(tempfile())
    on.exit(sink())
    invisible(force(x))
}

quiet(source("01_load.r"))

knitr::opts_chunk$set(
    fig.path = 'figures/',
    echo = FALSE,
    warning = FALSE,
    message = FALSE
)

options(
    knitr.kable.NA = ''
)

#source("S:/0000 - Analysts Shared Resources/r-share/login_box.r");
#login = getLogin();
#Connect and get the database
#sql = odbcConnect('PR_SAIL',login[1],login[2]);
#login = 0 # this will make your password anonymous

```


```{r datasheet, echo=FALSE, message=FALSE}
study_start <- ymd("2020-12-07")
study_end   <- ymd("2021-02-28")

# load cleaned data
d_analysis <- qread("data/d2_analysis_clean.qs") %>%
    mutate(
        qc_learn_cat = fct_recode(qc_learn_cat,
            "Yes" = "Learning disability / Down's"
        ),
        qc_bmi_cat = fct_recode(qc_bmi_cat,
            "15.0--18.4" = "15.0 <= BMI < 18.5",
            "18.5--24.9" = "18.5 <= BMI < 25.0",
            "25.0--29.9" = "25.0 <= BMI < 30.0",
            "30.0--39.9" = "30.0 <= BMI < 40.0",
            "40.0--46.9" = "40.0 <= BMI < 47.0"
        )
    )

# add labels to the variables
labelled::var_label(d_analysis) <- list(
     "has_event_cat"          = "Had an incident event",
     "vacc_type_time28_cat"   = "Vaccine type over time",
     "sex"                    = "Sex",
     "wimd_2019_quintile"     = "WIMD (2019) Quintile",
     "age_band"               = "Age-band",
     "n_tests_cat"            = "Previous number of tests",
     "qc_b2_82"               = "GP prescribed immunosuppressant medication",
     "qc_b2_leukolaba"        = "Prescribed leukotrinere or LABA",
     "qc_b2_prednisolone"     = "GP prescribed Oral steroids",
     "qc_b_af"                = "Atrial Fibrillation",
     "qc_b_ccf"               = "Heart failure",
     "qc_b_asthma"            = "Asthma",
     "qc_b_bloodcancer"       = "Cancer of blood or bone marrow",
     "qc_b_cerebralpalsy"     = "Cerebral palsy",
     "qc_b_chd"               = "Coronary heart disease",
     "qc_b_cirrhosis"         = "Cirrhosis of liver",
     "qc_b_congenheart"       = "Congenital heart disease",
     "qc_b_copd"              = "Chronic obstructive pulmonary disease",
     "qc_b_dementia"          = "Dementia",
     "qc_b_epilepsy"          = "Epilepsy",
     "qc_b_fracture4"         = "Osteoporotic fracture",
     "qc_b_neurorare"         = "Motor neurone disease",
     "qc_b_parkinsons"        = "Parkinson's disease",
     "qc_b_pulmhyper"         = "Pulmonary hypertension or pulmonary fibrosis",
     "qc_b_pulmrare"          = "Cystic fibrosis, bronchiectasis or alveolitis",
     "qc_b_pvd"               = "Peripheral vascular disease",
     "qc_b_ra_sle"            = "Rheumatoid arthritis or SLE",
     "qc_b_respcancer"        = "Respiratory cancer",
     "qc_b_semi"              = "Severe mental illness",
     "qc_b_sicklecelldisease" = "Sickle cell disease",
     "qc_b_stroke"            = "Stroke",
     "qc_diabetes_cat"        = "Diabetes",
     "qc_b_vte"               = "Thrombosis or pulmonary embolus",
     "qc_chemo_cat"           = "Chemotherapy",
     "qc_home_cat"            = "Housing status",
     "qc_learn_cat"           = "Learning disability / Down's syndrome",
     "qc_p_radio6"            = "Radiotherapy in previous 6 months",
     "qc_p_solidtransplant"   = "Solid organ transplant",
     "qc_renal_cat"           = "Chronic kidney disease (CKD)",
     "qc_bmi_cat"             = "BMI",
     "qc_sum_score_cat"       = "Q-COVID sum score",
     "smoking_cat"            = "Smoking status",
     "hypertension_cat"       = "Hypertension"
)
```

## Preamble

#### IGRP project 0911

#### Generated at/by

Compiled date: `r format(Sys.time(), '%a %d %B %Y')`
Please note all data coverage provided are up to above compiled date.

 - fatemeh.torabi@swansea.ac.uk
 - stuart.bedston@swansea.ac.uk
 - r.k.owen@swansea.ac.uk
 - a.akbari@swansea.ac.uk

#### Acknowledgements

 - Codes and classifications completed by Jane Lyons, Ronan Lyons, Peter Colins and Aziz Sheikh
 - This analysis has been completed in collaboration with con-cov team at Swansea University, Public Health Wales (PHW) and DaCVaP

## Introduction

This work expands on the work that has been done in Scotland and gives the results of analysis for investigations of safety of the COVID-19 vaccinations in Wales.  A concurrent self controlled case series study design along with a case-control study design where individuals with an incident consultation are matched with 10 individuals without the event in observation window, or up to the earliest event date during the study period for those who experienced an event. Vaccination status of both cases and controls determined at the date of the incident. An incident case is defined as the first event of each type during the observation window (i.e. an incident case of ITP outcome is an individual who experienced ITP during the study period but had no previous history of ITP while they could have had any other types of outcome events.)
For the case control analysis, 3 sets of conditional logistic regression models were fit: unadjusted, health-risk adjusted, and fully adjusted.


Our overall aim is to investigate the safety of Pfizer BioNTech and Oxford AstraZeneca COVID-19 vaccines. We will achieve this by: (a) studying the incidence and relative risk of mild-to-moderate and severe adverse events of interest identified through primary care data, hospitalisation through secondary care data and death from mortality data following vaccination for both first and second doses in the Welsh population. 

(b) identifying which population subgroups including age groups, clinically vulnerable, ethnicity and associated comorbidities who experience the highest relative frequency of health events of interest, and potentially are at greatest risk of observed adverse events. 


## Methods

### Study cohort

The study population are all alive individuals residing in Wales at the 2020-01-01 who are: 
  
  * Eligible to receive a COVID-19 vaccine.
  
  * Aged 16 or older up to 31st March 2020
  
  * Sex is known
  
  * Registered with a GP practice (and have minimum of 180 days period of registration prior for data availability)
  
  * Had no previous adverse event of interest between 2019-01-01 up to start of vaccination in Wales (2020-12-07)

### Data sources

The following data sources were used to identify adverse events and more specifically Vaccine Induced Thrombosis & Thrombocytopenia (VITT) events: 

  * WLGP: Welsh Primary Care - GP dataset
  * PEDW: Patient Episode Dataset for Wales
  * WRRS: Welsh Results Reporting Service - Pathology data for all tests and results across Wales. 

We have also used linked patients data from other sources compiled in a research ready data assets:

  * ADDD: Office for National Statistics (ONS) register of all deaths of Welsh residence. (Daily extract)
  * ADDE: Office for National Statistics (ONS) register of all deaths of Welsh residence. (Extract)
  * CDDS: COVID-19 Consolidated Deaths dataset 
  * CVVD: Vaccination records from the Welsh Immunisation System (WIS). Covers date of vaccination, type of vaccination and also has a flag for adverse   events immediately following vaccination (to be used by caution).
  *PATD: Active COVID-19 PCR testing and results. 
  WDDS: Welsh Dispensing Dataset. 
  
Research Ready Data Assets (RRDAs): 

  * C19_COHORT20: All individuals alive and living in Wales on the 1st January 2020 with follow-up to end of April 2021.
  * C19_COHORT20_MORTALITY: A cleaned and organised table of mortality records, refreshed on a daily basis with coverage up to 28 June 2021.
  * C19_DERIVED_VACCINATION: A cleaned and organised table of vaccination records, refreshed on a daily basis with coverage up to 10 July 2021.
  * JL_Q_COVID: A derived table containing Q COVID measures for all Welsh residents prior to the 7th of December 2020. 
  
## Cohort eligibility

**Please note:** That the <5 counts that can be seen in the 'Events Diff' column are referring to records have been removed due to either incomplete or erroneous information. This means that these are not a privacy risk.

```{r summary, echo = FALSE, message = FALSE}
read_csv("results/t_sample_selection_summary.csv", col_types = cols()) %>%
kable(
	digits = 1,
	format.args = list(big.mark = ","),
    col.names = c(
        "Step",
        "Sample criteria",
        "n",
        "Diff",
        "(%)",
        "n",
        "Diff",
        "(%)"
    )
) %>%
kable_styling(
    bootstrap_options = "striped",
    full_width = FALSE
) %>%
add_header_above(c(
    " "                    = 2,
    "Individuals"          = 3,
    "Events"               = 3
))
```


## Nested case-control design

Incident cases defined as anyone with an event in primary care or secondary care in the period after 7th December 2020 (start of the vaccination in Wales). A clearance period was applied to deduct those with events prior to vaccination. The interval chosen was 1st September 2019 to 6th December 2020. Matching was conducted based upon age (exact year up to 80, 2-year age-bands groups to 90, and 5-year age-bands above), gender and area of residence (middle-layer super output area; MSOA). Up to 10 controls were selected per case.  For individuals with multiple events in the vaccination period the date of the first event was used and subsequent events omitted.

Summary of the case-control matching showed that majorty cases were matched to 10 controls and there were a few who matched to less than 10 controls.

The statistical approach used conditional logistic regressions to model the risk of an event where the groups of case-control are included as separate strata. The unadjusted model had no other terms other than the strata and vaccination status. For the health-risk adjustment, the number of co-morbid conditions that a patient has was included as a categorical variable top-coded at 5. These are derived from the QCovid risk groups and are recorded using GP data up to 6th December 2020.  Fully adjusted models included additional terms for age, sex, deprivation (WIMD in quintiles), and number of previous PCR tests the individual had.


## Vaccine Induced Thrombosis & Thrombocytopenia events (VITT)

 - For Venous ThromboEmbolic (VTE) and CVST events, WRRS result were used to identify confirmed (Vaccine Induced Thrombosis & Thrombocytopenia) VITT events based on the following: 
 
    * Possible VITT   : Platelet < 150
    * Probable VITT   : Platelet < 150 & D-dimer > 2000
    * Confirmed VITT  : Platelet < 150 & Hit-assay=Positive (irrespective of the D-dimer)
    * VTE but not VITT: platelet >= 150
    * VTE unknown VITT: where there is no platelet count.
 
Pathology results were retrieved for all from start of observation window of 2020-12-07 until 2021-04-30.

The following table shows the number of patients with VTE and CVST who had a WRRS record for one or more of the above categories and the feasibility of using WRRS data to identify confirmed VITT events. 

```{r, echo = FALSE, message = FALSE}

t_vitt <-
    read_csv("results/t_vitt.csv", col_types = cols()) 

t_vitt$n[t_vitt$n < 5] <- "<5"

names(t_vitt) <- c("Incident category", "Platelet < 150","D-dimer < 2000","Positive hit assay","Platelet > 150","Number of cases")

t_vitt %>%
kable(
    align = c("l", "r", "r", "r", "r","r"))
```


## Results

The following results includes all events from WLGP and PEDW combined.

#### **Table 0:** Baseline characteristics for the cases and controls of the study cohort.

```{r baseline, echo = FALSE, message = FALSE}
xvar <- c(
    "has_event_cat",
    "vacc_type_time28_cat",
    "sex",
    "wimd_2019_quintile",
    "age_band",
    "n_tests_cat",
    "qc_b2_82",
    "qc_b2_leukolaba",
    "qc_b2_prednisolone",
    "qc_b_af",
    "qc_b_ccf",
    "qc_b_asthma",
    "qc_b_bloodcancer",
#   "qc_b_cerebralpalsy",
    "qc_b_chd",
    "qc_b_cirrhosis",
    "qc_b_congenheart",
    "qc_b_copd",
    "qc_b_dementia",
    "qc_b_epilepsy",
    "qc_b_fracture4",
    "qc_b_neurorare",
    "qc_b_parkinsons",
    "qc_b_pulmhyper",
    "qc_b_pulmrare",
    "qc_b_pvd",
    "qc_b_ra_sle",
    "qc_b_respcancer",
    "qc_b_semi",
#   "qc_b_sicklecelldisease",
    "qc_b_stroke",
    "qc_diabetes_cat",
    "qc_b_vte",
    "qc_chemo_cat",
    "qc_home_cat",
    "qc_learn_cat",
    "qc_p_radio6",
#   "qc_p_solidtransplant",
    "qc_renal_cat",
    "qc_bmi_cat",
    "qc_sum_score_cat",
    "smoking_cat",
    "hypertension_cat"
)

table_one <-
    d_analysis %>%
    mutate(
        has_event_cat = fct_recode(has_event_cat,
            "Yes" = "event_yes"
        ),
        qc_bmi_cat = fct_relevel(qc_bmi_cat,
            "15.0--18.4",
            "18.5--24.9",
            "25.0--29.9",
            "30.0--39.9",
            "40.0--46.9"
        )
    ) %>%
    CreateTableOne(
        vars = xvar,
        data = .,
        strata = "alf_type",
        test = FALSE
    )

kable_one <- KableOne(table_one, varLabels = TRUE)

# remove all the unnecessary '(%)'
rownames(kable_one) <- str_replace(rownames(kable_one), " \\(%\\)", "")

# remove "Dose 2" rows
which_dose2 <- str_detect(rownames(kable_one), "Dose 2") %>% which()
kable_one <- kable_one[-which_dose2, ]

# which rows need an indent
indent_rows <- str_detect(rownames(kable_one), "^ ") %>% which()

kable_one %>%
kable(
    align = c("r", "r")
) %>%
kable_styling(
    bootstrap_options = "striped",
    full_width = FALSE
) %>%
add_indent(
    indent_rows
)

```


### Reported venous thromboembolic, hemorrhagic, thrombocytopenia and Arterial thrombosis events from WLGP and PEDW

In Tables 1 and 2:

 - Individuals is the number of cases and controls with the respective vaccine exposure group at the date of incident
 - Events is the number of individual cases with an incident event from 7th December 2020 to 30th June 2021
 - Percent is number of events divided by individuals.
 - OR and 95% CI are the odds ratio and associated 95% confidence interval for each set of models. If there is no association between the event and vaccination the confidence intervals are expected to span 1.0.

```{r, echo = FALSE, message = FALSE}
t_desc_any      <- read_csv("results/t_desc_any.csv",             col_types = cols())
t_desc_type     <- read_csv("results/t_desc_event_type.csv",      col_types = cols())
t_coef_any      <- read_csv("results/t_coef_any_pretty.csv",      col_types = cols())
t_coef_hemo     <- read_csv("results/t_coef_hemo_pretty.csv",     col_types = cols())
t_coef_itp      <- read_csv("results/t_coef_itp_pretty.csv",      col_types = cols())
t_coef_thrmbcyt <- read_csv("results/t_coef_thrmbcyt_pretty.csv", col_types = cols())
t_coef_vt       <- read_csv("results/t_coef_vt_pretty.csv",       col_types = cols())
t_coef_at       <- read_csv("results/t_coef_at_pretty.csv",       col_types = cols())
t_coef_csvt     <- read_csv("results/t_coef_csvt_pretty.csv",     col_types = cols())
t_coef_mi       <- read_csv("results/t_coef_mi_pretty.csv",       col_types = cols())
t_coef_st       <- read_csv("results/t_coef_st_pretty.csv",       col_types = cols())


t_desc <- 
#  bind_rows(
#        t_desc_any,
        t_desc_type%>%
#   )

    mutate(
        event_type = if_else(event_type == "Venous thromboembolic events (excluding CSVT)", "Venous thromboembolic events (including CSVT)", event_type)
    )

t_coef <- bind_rows(
#    t_coef_any,
    t_coef_hemo,
    t_coef_itp,
    t_coef_thrmbcyt,
    t_coef_vt, 
    t_coef_at,
    t_coef_csvt,
    t_coef_mi,
    t_coef_st
)

t_desc_coef <-
    t_desc %>%
    left_join(
        t_coef,
        by = c(
            "event_type"     = "event_type",
            "vacc_type_time" = "term"
        )
    ) %>%
    mutate(
        unadjusted_or         = if_else(vacc_type_time == "UV",   1, unadjusted_or),
        health_adjusted_or    = if_else(vacc_type_time == "UV",   1, health_adjusted_or),
        fully_adjusted_or     = if_else(vacc_type_time == "UV",   1, fully_adjusted_or),
        unadjusted_ci.95      = if_else(vacc_type_time == "UV", "--", unadjusted_ci.95),
        health_adjusted_ci.95 = if_else(vacc_type_time == "UV", "--", health_adjusted_ci.95),
        fully_adjusted_ci.95  = if_else(vacc_type_time == "UV", "--", fully_adjusted_ci.95)
    ) %>%
    mutate(
        unadjusted_or      = if_else(unadjusted_or      > 10^6, Inf, unadjusted_or),
        health_adjusted_or = if_else(health_adjusted_or > 10^6, Inf, health_adjusted_or),
        fully_adjusted_or  = if_else(fully_adjusted_or  > 10^6, Inf, fully_adjusted_or)
    ) %>%
    mutate(
        event_type     = fct_inorder(event_type),
        vacc_type_time =
            vacc_type_time %>%
            fct_inorder() %>%
            fct_relevel(
                "AZ Dose 1 Day 00-28",
                "AZ Dose 1 Day 28+",
                "AZ Dose 2 Day 00+",  
                "PB Dose 1 Day 00-28",
                "PB Dose 1 Day 28+",
                "PB Dose 2 Day 00+",  
                after = Inf
            ) %>%
            fct_recode(
                "Unvaccinated" = "UV"
            ),
        p_event = str_c("(", str_trim(format(p_event, nsmall = 1)), "%)")
    ) %>%
    arrange(
        event_type,
        vacc_type_time
    ) %>%
    filter(
        # exclude Dose 2 rows
       # !str_detect(vacc_type_time, "Dose 2"),
        # exclude simple post-vacc rows
      #  !str_detect(vacc_type_time, "00\\+"),
        # exclude AZ 7-day intervals for Thrombocytopenia (ex ITP) and ITP
        !(event_type == "Thrombocytopenia (excluding ITP)"    & str_detect(vacc_type_time, "AZ Dose 1 Day (00-06|07\\-13|14\\-20|21\\-27)")),
        !(event_type == "Idiopathic thrombocytopenic purpura" & str_detect(vacc_type_time, "AZ Dose 1 Day (00-06|07\\-13|14\\-20|21\\-27)")),
        # exclude PB 7-day intervals for Thrombocytopenia (ex ITP) and ITP
        !(event_type == "Thrombocytopenia (excluding ITP)"    & str_detect(vacc_type_time, "PB Dose 1 Day (00-06|07\\-13|14\\-20|21\\-27)")),
        !(event_type == "Idiopathic thrombocytopenic purpura" & str_detect(vacc_type_time, "PB Dose 1 Day (00-06|07\\-13|14\\-20|21\\-27)"))
    ) %>%
    mutate(
        # number suppression
        n_individuals = format(n_individuals, big.mark = ",", trim = TRUE),
        n_individuals = if_else(n_individuals %in% as.character(1:4), "<5", n_individuals),
        n_event = format(n_event, big.mark = ",", trim = TRUE),
        n_event = if_else(n_event %in% as.character(1:4), "<5", n_event),
        p_event = if_else(n_event == "<5", NA_character_, p_event)
    )

```

#### **Table 1:** Number of individuals and events, and unadjusted, health-risk adjusted and fully adjusted odds ratios with 95% confidence intervals for the ChAdOx1 vaccine.

```{r, echo = FALSE, message = FALSE}
pr_event_type <-
    t_desc_coef %>%
    filter(str_detect(vacc_type_time, "(Unvaccinated|AZ)")) %>%
    mutate(event_type = fct_inorder(event_type)) %>%
    count(event_type)

pr_index <- pr_event_type$n
names(pr_index) <- pr_event_type$event_type

t_desc_coef %>%
filter(str_detect(vacc_type_time, "(Unvaccinated|AZ)")) %>%
select(-event_type) %>%
mutate(
    vacc_type_time = str_replace(vacc_type_time, "AZ ", "")
) %>%
kable(
    align = c("l","r","r","r","r","c","r","c","r","c"),
    digits = c(0, 0, 0, 1, 2, 0, 2, 0, 2, 0),
    format.args = list(big.mark = ","),
    booktabs = FALSE,
    col.names = c(
        "Vaccination period",
        "individuals",
        "Events",
        "(%)",
        "OR",
        "95% CI",
        "OR",
        "95% CI",
        "OR",
        "95% CI"
    )
) %>%
kable_styling(
    bootstrap_options = "striped"
) %>%
pack_rows(
    index = pr_index
) %>%
add_header_above(c(
    " "                    = 1,
    "Counts"               = 3,
    "Unadjusted"           = 2,
    "Health-risk adjusted" = 2,
    "Fully adjusted"       = 2
))
```

#### **Table 2:** Number of individuals and events, and unadjusted, health-risk adjusted and fully adjusted odds ratios with 95% confidence intervals for the BNT162b2 vaccine.

```{r, echo = FALSE, message = FALSE}
pr_event_type <-
    t_desc_coef %>%
    filter(str_detect(vacc_type_time, "(Unvaccinated|PB)")) %>%
    mutate(event_type = fct_inorder(event_type)) %>%
    count(event_type)

pr_index <- pr_event_type$n
names(pr_index) <- pr_event_type$event_type

t_desc_coef %>%
filter(str_detect(vacc_type_time, "(Unvaccinated|PB)")) %>%
select(-event_type) %>%
mutate(
    vacc_type_time = str_replace(vacc_type_time, "PB ", "")
) %>%
kable(
    align = c("l","r","r","r","r","c","r","c","r","c"),
    digits = c(0, 0, 0, 1, 2, 0, 2, 0, 2, 0),
    format.args = list(big.mark = ","),
    booktabs = FALSE,
    col.names = c(
        "Vaccination period",
        "individuals",
        "Events",
        "(%)",
        "OR",
        "95% CI",
        "OR",
        "95% CI",
        "OR",
        "95% CI"
    )
) %>%
kable_styling(
    bootstrap_options = "striped"
) %>%
pack_rows(
    index = pr_index
) %>%
add_header_above(c(
    " "                    = 1,
    "Counts"               = 3,
    "Unadjusted"           = 2,
    "Health-risk adjusted" = 2,
    "Fully adjusted"       = 2
))
```

